{% extends "base.html" %}
{% block title %}Capture Live{% endblock %}
{% block page_title %}Capture Live{% endblock %}

{% block extra_style %}
<style>
/* Controls bar */
.capture-bar {
  display:flex; align-items:center; gap:10px; flex-wrap:wrap;
}

/* Live indicator */
.live-ind {
  display:flex; align-items:center; gap:7px;
  padding: 7px 14px;
  background:var(--surface2); border:1px solid var(--border);
  border-radius:8px;
  font-family:'IBM Plex Mono',monospace; font-size:0.75rem;
  color:var(--text-muted);
}
.live-dot {
  width:8px; height:8px; border-radius:50%;
  background:var(--text-muted); flex-shrink:0;
}
.live-dot.live {
  background:var(--rose);
  box-shadow:0 0 8px var(--rose);
  animation:blink-live 0.8s ease infinite;
}
@keyframes blink-live { 0%,100%{opacity:1} 50%{opacity:0.25} }

/* Stats bar */
.stats-strip {
  display:flex; align-items:center; gap:0;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:10px; overflow:hidden;
}
.stats-strip-item {
  flex:1; padding:12px 16px;
  border-right:1px solid var(--border);
  font-family:'IBM Plex Mono',monospace;
}
.stats-strip-item:last-child { border-right:none; }
.stats-strip-label {
  font-size:0.58rem; font-weight:700;
  letter-spacing:0.15em; text-transform:uppercase;
  color:var(--text-muted); margin-bottom:4px;
}
.stats-strip-val {
  font-size:1.1rem;
}
.stats-strip-val.blue   { color:var(--indigo-lt); }
.stats-strip-val.green  { color:var(--emerald); }
.stats-strip-val.amber  { color:var(--amber); }
.stats-strip-val.rose   { color:var(--rose); }
.stats-strip-val.plain  { color:var(--text); }

/* Filter bar */
.filter-bar {
  display:flex; align-items:center; gap:10px;
  padding:12px 16px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:10px;
}
.filter-check {
  display:flex; align-items:center; gap:6px;
  cursor:pointer; font-size:0.78rem; color:var(--text-muted);
  user-select:none;
}
.filter-check input { accent-color:var(--rose); cursor:pointer; }

/* Packet table */
.packets-wrap { max-height:calc(100vh - 420px); overflow-y:auto; }

/* Detail panel */
.detail-panel {
  background:var(--surface);
  border:1px solid var(--border2);
  border-radius:10px; padding:20px;
  display:none;
}
.detail-panel.show { display:block; }
.detail-panel-head {
  display:flex; align-items:center; gap:12px; margin-bottom:18px;
}
.detail-panel-head h4 {
  font-size:0.75rem; letter-spacing:0.12em;
  text-transform:uppercase; color:var(--indigo-lt); flex:1;
}
.detail-close {
  background:transparent; border:1px solid var(--border2);
  border-radius:6px; width:28px; height:28px;
  color:var(--text-muted); cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  font-size:1rem; transition:all 0.2s;
}
.detail-close:hover { border-color:var(--rose); color:var(--rose); }
.detail-grid {
  display:grid; grid-template-columns:1fr 1fr; gap:10px;
}
.detail-field { display:flex; flex-direction:column; gap:3px; }
.detail-label {
  font-size:0.6rem; font-weight:700;
  letter-spacing:0.16em; text-transform:uppercase;
  color:var(--text-muted); font-family:'IBM Plex Mono',monospace;
}
.detail-val {
  font-family:'IBM Plex Mono',monospace;
  font-size:0.82rem; color:var(--text);
}
.reason-tag {
  display:inline-flex; align-items:center;
  background:rgba(244,63,94,0.08);
  border:1px solid rgba(244,63,94,0.25);
  border-radius:5px; padding:3px 9px;
  font-size:0.68rem; font-family:'IBM Plex Mono',monospace;
  color:var(--rose); margin:2px 3px 2px 0;
}

/* Duration */
.duration-badge {
  padding:6px 13px;
  background:var(--surface2); border:1px solid var(--border);
  border-radius:8px;
  font-family:'IBM Plex Mono',monospace;
  font-size:0.78rem; color:var(--text-muted);
}

/* Row selected */
.pkt-row { cursor:pointer; }
.pkt-row.selected { background:rgba(99,102,241,0.07) !important; }
</style>
{% endblock %}

{% block content %}

<!-- Controls -->
<div class="card mb-16">
  <div class="card-body" style="padding:14px 20px;">
    <div class="capture-bar">
      <div class="live-ind">
        <div class="live-dot" id="live-dot"></div>
        <span id="live-label">Inactif</span>
      </div>

      <select class="iface-select" id="iface-select">
        <option value="">Interface auto</option>
      </select>

      <button class="btn btn-success" id="btn-start" onclick="startCapture()">
        <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
        Démarrer
      </button>
      <button class="btn btn-danger" id="btn-stop" onclick="stopCapture()" disabled>
        <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="1"/></svg>
        Arrêter
      </button>
      <button class="btn btn-muted" onclick="clearPackets()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
        </svg>
        Vider
      </button>

      <div style="flex:1"></div>
      <div class="duration-badge" id="dur">00:00:00</div>
    </div>
  </div>
</div>

<!-- Stats strip -->
<div class="stats-strip mb-16">
  <div class="stats-strip-item">
    <div class="stats-strip-label">Total</div>
    <div class="stats-strip-val blue" id="s-total">0</div>
  </div>
  <div class="stats-strip-item">
    <div class="stats-strip-label">TCP</div>
    <div class="stats-strip-val blue" id="s-tcp">0</div>
  </div>
  <div class="stats-strip-item">
    <div class="stats-strip-label">UDP</div>
    <div class="stats-strip-val green" id="s-udp">0</div>
  </div>
  <div class="stats-strip-item">
    <div class="stats-strip-label">ICMP</div>
    <div class="stats-strip-val amber" id="s-icmp">0</div>
  </div>
  <div class="stats-strip-item">
    <div class="stats-strip-label">Suspects</div>
    <div class="stats-strip-val rose" id="s-susp">0</div>
  </div>
  <div class="stats-strip-item">
    <div class="stats-strip-label">Volume</div>
    <div class="stats-strip-val plain" id="s-bytes">0 B</div>
  </div>
</div>

<!-- Filters -->
<div class="filter-bar mb-16">
  <input type="text" class="filter-input" id="fip" placeholder="Filtrer par IP..." oninput="applyFilter()">
  <select class="filter-select" id="fproto" onchange="applyFilter()">
    <option value="">Tous protocoles</option>
    <option value="TCP">TCP</option>
    <option value="UDP">UDP</option>
    <option value="ICMP">ICMP</option>
  </select>
  <label class="filter-check">
    <input type="checkbox" id="fsusp" onchange="applyFilter()">
    Suspects uniquement
  </label>
  <div style="flex:1"></div>
  <span class="text-muted" id="fc">0 paquets</span>
</div>

<!-- Table -->
<div class="card mb-16">
  <div class="card-body" style="padding:0;">
    <div class="packets-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th><th>Heure</th><th>IP Source</th><th>IP Destination</th>
            <th>Proto</th><th>Port Src</th><th>Port Dst</th>
            <th>Flags</th><th>Taille</th><th>Statut</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr>
            <td colspan="10" style="text-align:center;color:var(--text-muted);padding:48px;font-family:'IBM Plex Mono',monospace;font-size:0.8rem;">
              En attente de capture…
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Detail panel -->
<div class="detail-panel" id="dpanel">
  <div class="detail-panel-head">
    <h4>Détails du paquet</h4>
    <div style="flex:1;height:1px;background:var(--border)"></div>
    <button class="detail-close" onclick="document.getElementById('dpanel').classList.remove('show')">×</button>
  </div>
  <div class="detail-grid" id="dcontent"></div>
  <div id="dreasons" style="margin-top:14px;"></div>
</div>

{% endblock %}

{% block scripts %}
<script>
let allPkts = [], filtPkts = [], capturing = false, startTime = null, durTimer = null;
const socket = io();

fetch('/api/interfaces').then(r=>r.json()).then(d => {
  const s = document.getElementById('iface-select');
  d.interfaces.forEach(i => {
    const o = document.createElement('option'); o.value = i; o.textContent = i; s.appendChild(o);
  });
}).catch(()=>{});

socket.on('new_packet', p => {
  allPkts.push(p);
  if (matchFilter(p)) {
    filtPkts.push(p); appendRow(p);
    document.getElementById('fc').textContent = filtPkts.length + ' paquets';
  }
});

socket.on('stats_update', s => {
  document.getElementById('s-total').textContent = s.total;
  document.getElementById('s-tcp').textContent   = s.tcp;
  document.getElementById('s-udp').textContent   = s.udp;
  document.getElementById('s-icmp').textContent  = s.icmp;
  document.getElementById('s-susp').textContent  = s.suspicious;
  const b = s.bytes;
  document.getElementById('s-bytes').textContent =
    b < 1024 ? b+' B' : b < 1048576 ? (b/1024).toFixed(1)+' KB' : (b/1048576).toFixed(2)+' MB';
  updateSidebarStatus(true);
});

function startCapture() {
  const iface = document.getElementById('iface-select').value;
  fetch('/api/capture/start', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({iface: iface || null})
  }).then(r=>r.json()).then(() => {
    capturing = true; startTime = Date.now();
    document.getElementById('btn-start').disabled = true;
    document.getElementById('btn-stop').disabled  = false;
    document.getElementById('live-dot').classList.add('live');
    document.getElementById('live-label').textContent = 'En direct';
    document.getElementById('live-label').style.color = 'var(--rose)';
    durTimer = setInterval(updateDur, 1000);
    showToast('Capture démarrée', 'success');
  });
}

function stopCapture() {
  fetch('/api/capture/stop', {method:'POST'}).then(r=>r.json()).then(() => {
    capturing = false;
    document.getElementById('btn-start').disabled = false;
    document.getElementById('btn-stop').disabled  = true;
    document.getElementById('live-dot').classList.remove('live');
    document.getElementById('live-label').textContent = 'Arrêtée';
    document.getElementById('live-label').style.color = 'var(--amber)';
    clearInterval(durTimer);
    updateSidebarStatus(false);
    showToast('Capture arrêtée — ' + allPkts.length + ' paquets', 'info');
  });
}

function clearPackets() {
  allPkts = []; filtPkts = [];
  document.getElementById('tbody').innerHTML =
    '<tr><td colspan="10" style="text-align:center;color:var(--text-muted);padding:48px;font-family:\'IBM Plex Mono\',monospace;font-size:0.8rem;">En attente…</td></tr>';
  document.getElementById('fc').textContent = '0 paquets';
  document.getElementById('dpanel').classList.remove('show');
}

function updateDur() {
  const e = Math.floor((Date.now() - startTime) / 1000);
  document.getElementById('dur').textContent =
    `${String(Math.floor(e/3600)).padStart(2,'0')}:${String(Math.floor((e%3600)/60)).padStart(2,'0')}:${String(e%60).padStart(2,'0')}`;
}

function matchFilter(p) {
  const ip   = document.getElementById('fip').value.trim();
  const proto= document.getElementById('fproto').value;
  const susp = document.getElementById('fsusp').checked;
  if (ip    && !p.src.includes(ip) && !p.dst.includes(ip)) return false;
  if (proto && p.proto !== proto) return false;
  if (susp  && !p.suspicious) return false;
  return true;
}

function applyFilter() {
  filtPkts = allPkts.filter(matchFilter);
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  if (!filtPkts.length) {
    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:var(--text-muted);padding:48px;font-family:\'IBM Plex Mono\',monospace;font-size:0.8rem;">Aucun résultat</td></tr>';
  } else {
    filtPkts.slice(-200).forEach(appendRow);
  }
  document.getElementById('fc').textContent = filtPkts.length + ' paquets';
}

function pb(p) {
  const m = {TCP:'tcp', UDP:'udp', ICMP:'icmp'};
  return `<span class="badge badge-${m[p]||'other'}">${p}</span>`;
}

function appendRow(p) {
  const tbody = document.getElementById('tbody');
  if (tbody.children.length === 1 && tbody.children[0].children[0]?.colSpan == 10) tbody.innerHTML = '';
  const tr = document.createElement('tr');
  tr.className = 'pkt-row' + (p.suspicious ? ' suspicious' : '');
  tr.innerHTML = `
    <td class="text-muted">${p.id}</td>
    <td class="mono" style="font-size:0.73rem;color:var(--text-muted)">${p.timestamp}</td>
    <td class="mono" style="font-size:0.82rem">${p.src}</td>
    <td class="mono" style="font-size:0.82rem">${p.dst}</td>
    <td>${pb(p.proto)}</td>
    <td class="text-muted">${p.sport ?? '—'}</td>
    <td>${p.dport ? `<strong class="mono">${p.dport}</strong>` : '—'}</td>
    <td class="mono" style="font-size:0.73rem">${p.flags ?? '—'}</td>
    <td class="text-muted">${p.length}B</td>
    <td>${p.suspicious ? '<span class="badge badge-susp">⚠ SUSPECT</span>' : '<span class="badge badge-ok">OK</span>'}</td>`;
  tr.onclick = () => showDetail(p, tr);
  tbody.appendChild(tr);
  tbody.closest('.packets-wrap').scrollTop = 9999;
}

function showDetail(p, row) {
  document.querySelectorAll('.pkt-row.selected').forEach(r => r.classList.remove('selected'));
  row.classList.add('selected');
  document.getElementById('dpanel').classList.add('show');
  const fields = [
    ['ID', p.id], ['Heure', p.timestamp],
    ['IP Source', p.src], ['IP Destination', p.dst],
    ['Protocole', p.proto], ['Port Source', p.sport ?? '—'],
    ['Port Destination', p.dport ?? '—'], ['Flags TCP', p.flags ?? '—'],
    ['Taille', p.length + ' octets'], ['Statut', p.suspicious ? '⚠ SUSPECT' : '✓ Normal']
  ];
  document.getElementById('dcontent').innerHTML = fields.map(([l,v]) =>
    `<div class="detail-field"><span class="detail-label">${l}</span><span class="detail-val">${v}</span></div>`
  ).join('');
  const rd = document.getElementById('dreasons');
  rd.innerHTML = p.reasons?.length
    ? '<div class="detail-label" style="margin-bottom:7px;">Raisons de suspicion</div>' +
      p.reasons.map(r => `<span class="reason-tag">⚠ ${r}</span>`).join('') : '';
}

fetch('/api/capture/status').then(r=>r.json()).then(d => {
  if (d.running) {
    document.getElementById('btn-start').disabled = true;
    document.getElementById('btn-stop').disabled  = false;
    document.getElementById('live-dot').classList.add('live');
    document.getElementById('live-label').textContent = 'En direct';
    document.getElementById('live-label').style.color = 'var(--rose)';
    startTime = Date.now(); durTimer = setInterval(updateDur, 1000);
  }
}).catch(()=>{});
</script>
{% endblock %}